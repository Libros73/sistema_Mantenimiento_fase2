<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNB - Gesti√≥n Multi-Cliente</title>
    <style>
        /* ESTILOS (CSS) */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f2f5; color: #333; }
        .main-container { max-width: 1100px; margin: 30px auto; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; }
        
        /* Header */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #ecf0f1; margin-bottom: 20px; }
        .logo-area h1 { color: #2c3e50; font-size: 24px; }
        .user-info { display: flex; align-items: center; gap: 10px; background: #eef2f7; padding: 8px 15px; border-radius: 20px; font-weight: bold; color: #2980b9; }

        /* Acciones */
        .actions-bar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .btn-primary { background-color: #2980b9; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; }
        .btn-danger { background-color: #c0392b; color: white; }
        .btn-small { border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; }
        
        /* Tabla */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        thead { background-color: #f8f9fa; }
        th { text-align: left; padding: 12px; font-size: 13px; color: #7f8c8d; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        /* Badges y Tags */
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-ok { background-color: #e8f8f5; color: #27ae60; }
        .status-fail { background-color: #fdedec; color: #c0392b; }
        .client-tag { background: #eaf2f8; color: #2980b9; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #a9cce3; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 500px; max-width: 90%; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-secondary { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="main-container">
        <header class="dashboard-header">
            <div class="logo-area">
                <h1>
                    {% if cliente_actual %}
                        üè¢ {{ cliente_actual.nombre }}
                    {% else %}
                        üåê Gesti√≥n Global
                    {% endif %}
                </h1>
                <p>Sistema Centralizado de Mantenimiento</p>
            </div>
            
            <div class="user-info" style="gap: 5px;">
                <select onchange="filtrarCliente(this.value)" style="padding: 5px; border-radius: 5px; border: 1px solid #bdc3c7;">
                    <option value="">üåé Ver Todos</option>
                    {% for c in clientes %}
                        <option value="{{ c.id }}" {% if cliente_actual and cliente_actual.id == c.id %}selected{% endif %}>
                            üè¢ {{ c.nombre }}
                        </option>
                    {% endfor %}
                </select>
                
                <button onclick="abrirModalCliente()" style="background: #27ae60; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-weight: bold;" title="Crear Nuevo Edificio/Cliente">+</button>
                
                <span style="margin-left: 10px;">Ingeniero</span>
            </div>
        </header>

        <div class="actions-bar">
            <h2>Inventario de Dispositivos</h2>
            <div>
                <a href="/exportar-pdf" id="btnPdf" class="btn-primary" style="background-color: #e74c3c; margin-right: 10px;">üìÑ PDF Reporte</a>
                
                <button class="btn-primary" onclick="abrirModal()">+ Nuevo Equipo</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente / Edificio</th>
                    <th>Equipo</th>
                    <th>Serial</th>
                    <th>Ubicaci√≥n</th>
                    <th>Observaciones</th> <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for equipo in equipos %}
                <tr>
                    <td>#{{ equipo.id }}</td>
                    <td><span class="client-tag">üè¢ {{ equipo.cliente.nombre }}</span></td>
                    <td><strong>{{ equipo.nombre }}</strong><br><small>{{ equipo.tipo }}</small></td>
                    <td><code>{{ equipo.serial }}</code></td>
                    <td>{{ equipo.ubicacion }}</td>
                    
                    <td style="font-style: italic; color: #666; font-size: 13px; max-width: 200px;">
                        {{ equipo.observaciones or '' }}
                    </td>

                    <td>
                        <span class="status-badge {{ 'status-ok' if equipo.estado == 'Operativo' else 'status-fail' }}">
                            {{ equipo.estado }}
                        </span>
                    </td>
                    <td>
                        <button class="btn-small" style="background-color: #f1c40f;"
                            onclick="editarEquipo(
                                '{{ equipo.id }}', 
                                '{{ equipo.cliente_id }}'
                            )">
                            ‚úèÔ∏è
                        </button>
                        <input type="hidden" id="data-nombre-{{ equipo.id }}" value="{{ equipo.nombre }}">
                        <input type="hidden" id="data-tipo-{{ equipo.id }}" value="{{ equipo.tipo }}">
                        <input type="hidden" id="data-serial-{{ equipo.id }}" value="{{ equipo.serial }}">
                        <input type="hidden" id="data-ubicacion-{{ equipo.id }}" value="{{ equipo.ubicacion }}">
                        <input type="hidden" id="data-obs-{{ equipo.id }}" value="{{ equipo.observaciones or '' }}">

                        <button class="btn-small btn-danger" onclick="eliminarEquipo({{ equipo.id }})">üóëÔ∏è</button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="8" style="text-align: center;">No hay equipos registrados.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="modalAgregar" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle">üîå Datos del Dispositivo</h3>
            
            <div class="form-group">
                <label>Cliente (Edificio):</label>
                <select id="inpCliente">
                    <option value="">Cargando clientes...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Nombre del Equipo:</label>
                <input type="text" id="inpNombre" placeholder="Ej: Sensor Humo">
            </div>

            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>Tipo:</label>
                    <select id="inpTipo">
                        <option value="Panel Control">Panel Control</option>
                        <option value="Sensor Humo">Sensor Humo</option>
                        <option value="Estaci√≥n Manual">Estaci√≥n Manual</option>
                        <option value="Bomba">Bomba Contra Incendio</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label>Serial:</label>
                    <input type="text" id="inpSerial" placeholder="SN-123">
                </div>
            </div>

            <div class="form-group">
                <label>Ubicaci√≥n:</label>
                <input type="text" id="inpUbicacion" placeholder="Ej: S√≥tano 1">
            </div>

            <div class="form-group">
                <label>Observaciones:</label>
                <textarea id="inpObservaciones" rows="2" placeholder="Notas adicionales..."></textarea>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button onclick="cerrarModal()" class="btn-secondary">Cancelar</button>
                <button id="btnGuardar" onclick="guardarEquipo()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>
    <div id="modalCliente" class="modal-overlay">
        <div class="modal-box" style="width: 400px;"> <h3>üè¢ Nuevo Edificio / Cliente</h3>
            
            <div class="form-group">
                <label>Nombre del Cliente:</label>
                <input type="text" id="cliNombre" placeholder="Ej: Torre Colpatria">
            </div>

            <div class="form-group">
                <label>Direcci√≥n:</label>
                <input type="text" id="cliDireccion" placeholder="Ej: Cra 7 # 24-89">
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button onclick="document.getElementById('modalCliente').style.display='none'" class="btn-secondary">Cancelar</button>
                <button onclick="guardarCliente()" class="btn-primary">Crear Cliente</button>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('modalAgregar');
        const selectCliente = document.getElementById('inpCliente');
        let idEnEdicion = null; 

        // 1. L√≥gica de Filtrado y Actualizaci√≥n de PDF
        function filtrarCliente(id) {
            if (id) {
                window.location.href = '/?cliente_id=' + id;
            } else {
                window.location.href = '/'; 
            }
        }

        // 2. Carga Inicial
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const clienteActualId = params.get('cliente_id');
            const btnPdf = document.getElementById('btnPdf');

            // --- AQU√ç EST√Å LA MAGIA ---
            // Si hay un cliente filtrado, le avisamos al bot√≥n PDF
            if (clienteActualId) {
                btnPdf.href = '/exportar-pdf?cliente_id=' + clienteActualId;
            }

            fetch('/api/clientes')
                .then(res => res.json())
                .then(clientes => {
                    selectCliente.innerHTML = '<option value="">-- Seleccione Cliente --</option>';
                    clientes.forEach(c => {
                        let option = document.createElement('option');
                        option.value = c.id;
                        option.text = c.nombre;
                        if (clienteActualId && c.id == clienteActualId) {
                            option.selected = true;
                        }
                        selectCliente.appendChild(option);
                    });
                })
                .catch(err => console.error("Error cargando clientes:", err));
        });

        // 3. Abrir Modal
        function abrirModal() { 
            idEnEdicion = null; 
            document.getElementById('modalTitle').innerText = "üîå Nuevo Dispositivo";
            document.getElementById('btnGuardar').innerText = "Guardar Nuevo";
            
            document.getElementById('inpNombre').value = "";
            document.getElementById('inpSerial').value = "";
            document.getElementById('inpUbicacion').value = "";
            document.getElementById('inpObservaciones').value = "";
            
            modal.style.display = 'flex'; 
        }

        function cerrarModal() { 
            modal.style.display = 'none'; 
        }

        // 4. Editar
        function editarEquipo(id, clienteId) {
            idEnEdicion = id;
            
            const nombre = document.getElementById('data-nombre-' + id).value;
            const tipo = document.getElementById('data-tipo-' + id).value;
            const serial = document.getElementById('data-serial-' + id).value;
            const ubicacion = document.getElementById('data-ubicacion-' + id).value;
            const observaciones = document.getElementById('data-obs-' + id).value;

            document.getElementById('inpNombre').value = nombre;
            document.getElementById('inpTipo').value = tipo;
            document.getElementById('inpSerial').value = serial;
            document.getElementById('inpUbicacion').value = ubicacion;
            document.getElementById('inpObservaciones').value = observaciones;
            document.getElementById('inpCliente').value = clienteId;

            document.getElementById('modalTitle').innerText = "‚úèÔ∏è Editar Dispositivo";
            document.getElementById('btnGuardar').innerText = "Actualizar";
            
            modal.style.display = 'flex';
        }

        // 5. Guardar
        function guardarEquipo() {
            const datos = {
                cliente_id: selectCliente.value,
                nombre: document.getElementById('inpNombre').value,
                tipo: document.getElementById('inpTipo').value,
                serial: document.getElementById('inpSerial').value,
                ubicacion: document.getElementById('inpUbicacion').value,
                observaciones: document.getElementById('inpObservaciones').value
            };

            if(!datos.cliente_id || !datos.nombre || !datos.serial) {
                alert("‚ö†Ô∏è Por favor completa: Cliente, Nombre y Serial.");
                return;
            }

            let url = '/api/equipos';
            let metodo = 'POST';

            if (idEnEdicion !== null) {
                url = '/api/equipos/' + idEnEdicion;
                metodo = 'PUT';
            }

            fetch(url, {
                method: metodo,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(datos)
            })
            .then(res => res.json())
            .then(data => {
                alert(data.mensaje);
                location.reload();
            })
            .catch(err => {
                console.error(err);
                alert("Error al guardar. Verifica la consola.");
            });
        }

        // 6. Eliminar
        function eliminarEquipo(id) {
            if(confirm("¬øSeguro de borrar este equipo?")) {
                fetch('/api/equipos/' + id, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    alert(data.mensaje);
                    location.reload();
                });
            }
        }

        window.onclick = function(event) {
            if (event.target == modal) { cerrarModal(); }
        }
    // --- L√ìGICA PARA NUEVO CLIENTE ---
        function abrirModalCliente() {
            document.getElementById('cliNombre').value = "";
            document.getElementById('cliDireccion').value = "";
            document.getElementById('modalCliente').style.display = 'flex';
        }

        function guardarCliente() {
            const nombre = document.getElementById('cliNombre').value;
            const direccion = document.getElementById('cliDireccion').value;

            if(!nombre) {
                alert("El nombre es obligatorio");
                return;
            }

            fetch('/api/clientes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nombre: nombre, direccion: direccion })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.mensaje);
                window.location.href = '/'; // Recargamos para que aparezca en la lista
            });
        }
    </script>
</body>
</html>